#!/bin/bash

ROOT=`pwd`
DawnCC=$ROOT/../../../DawnCC/DawnCC-Compiler/
Benchs_O=$ROOT/../Original/
Benchs_DawnCC=$ROOT/../DawnCC_BENCHS/

#Remove files generated by DawnCC:
cd $Benchs_O
files=$(find . -name "*_AI.c")
for f in $files; do
  rm $Benchs_O/$f
done
cd $ROOT
cd $Benchs_O
files=$(find . -name "*_AI.cpp")
for f in $files; do
  rm $Benchs_O/$f
done
cd $ROOT
cd $Benchs_O
files=$(find . -name "*_AI.h")
for f in $files; do
  rm $Benchs_O/$f
done
cd $ROOT

#collect statistics:
#
# ORIGNAL BENCHMARKS
#
cd $Benchs_O
PRAGS_O=$(grep -rn "#pragma omp" .)
cd $ROOT

echo "$PRAGS_O" &> tmp.txt
NUM_PRAGS_O=$(wc -l < tmp.txt)

# Run DawnCC
bash $DawnCC/run.sh -d $DawnCC -src $Benchs_O -pl false -ps 2 -mc false

# Create a dir to store DawnCC Results
rm -rf $Benchs_DawnCC
cp -r $Benchs_O $Benchs_DawnCC

#Replace _AI files
cd $Benchs_DawnCC
files=$(find . -name "*_AI.c")
for f in $files; do
  mv $f ${f%_AI.c}.c
done
cd $ROOT

cd $Benchs_DawnCC
files=$(find . -name "*_AI.cpp")
for f in $files; do
  mv $f ${f%_AI.cpp}.cpp
done
cd $ROOT

cd $Benchs_DawnCC
files=$(find . -name "*_AI.h")
for f in $files; do
  mv $f ${f%_AI.h}.h
done
cd $ROOT


#collect statistics:
#
#  DawnCC
#
cd $Benchs_DawnCC
PRAGS_DawnCC=$(grep -rn "#pragma omp" .)
cd $ROOT

echo "$PRAGS_DawnCC" &> tmp.txt
NUM_PRAGS_DawnCC=$(wc -l < tmp.txt)

rm tmp.txt

#Process the result
DIF=$(( $NUM_PRAGS_DawnCC - $NUM_PRAGS_O ))
echo "NUMBER OF PRAGMAS - ORIGINAL DIR : $NUM_PRAGS_O"
echo "NUMBER OF PRAGMAS - DAWNCC DIR : $NUM_PRAGS_DawnCC"
echo "NUMBER OF PRAGMAS INSERTED BY DAWNCC : $DIF"

